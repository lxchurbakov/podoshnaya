# Проработка

## Подошная

Подошная это приложение, которое можно запустить (локально или в облаке) и присоединиться к нему с помощью CLI. Подошная поднимает TCP порт и слушает соединения. CLI соединяется с портом и закидывает команды.

Чтобы запустить подошную, можно воспользоваться командой:

```
pod host start -- запускает локальную подошную
               -- принимает --port
```

Для того, чтобы соединиться с подошной через CLI, нужно добавить её с помощью pod remote:

```
pod remote add origin localhost:3000 -- добавляет подошную в CLI
pod remote list -- выводит список подошных
pod remote remove origin -- удаляет подошную
```

## Поды

Под - это просто JS скрипт (файл), который экспортирует асинхронную функцию (для запуска), а также может экспортировать (поименно) разные другие значения. Минимальный под выглядит вот так:

```
export default async (params, bus, p8a) => {
    console.log('it is up');
};
```

Поды можно загружать в подошную с помощью команды pod push:

```
pod push origin name test.js -- отправляет под в подошную (образ)
pod start origin name -- запускает под в подошной
pod stop origin name -- останавливает (убивает под в подошной)
pod status origin name -- проверяет как там статус у пода - запущен или нет
pod remove origin name -- удаляет под (образ) из подошной
```

После пуша пода он остается в подошной и можно его останавливаеть или запускать сколько угодно раз. Запущенный под будет перезапущен если подошная умрет и перезапустится. Таким образом подошная гарантирует, что если её аптайм обеспечен, то аптайм подов тоже будет обеспечен.

Поды запускаются в общем пространстве. Это небезопасно, но пока что так надо. Единственное, что подразумевается, что все не-нодовские зависимости будут зашиты в под (бандлом), а вот нодовские (fs, child process и тд) он может свободно брать из родительского пространства.

У каждого пода есть статус - idle (не запущен), waiting (запускается), error (поломан), up (запущен). Изначально пушнутый под бует в статусе idle.

В процессе запуска пода может возникнуть ошибка. Подошная это залогирует и перезапустит под (сделает несколько попыток). Если с N попыток он не поднимется, статус пода будет error. Во время попыток перезапуска статус пода будет waiting.

В процессе жизни пода подошная будет его пинговать, под должен отвечать на событие в шине. `bus.on('check', () => bus.emit('status', 'up'))`. Если под ответит не статусом `up` или не ответит вовсе, подошная будет считать его умершим и попробует перезапустить.

При запуске можно передавать параметры, например:

```
pod start origin main --value 24 -- в params будет { value: '24' }
```

## Вложенность подов

Главная фишка подошных это возможность вкладывать их друг в друга. Под может создать свою подошную и самостоятельно оперировать скриптами, запускать и останавливать их. Самый простой способ это заспавнить скрипт `pod host start`, но это потребует нового порта и просто будет запускать скрипты подов на сервере. Есть более гибкий способ:

```
export default async (params, bus, p8a) => {
    p8a.host('inner', {
        push: (pod, params) => {
            // Складываем под в fs
        },
        start: (name, params) => {
            // запускаем под
        },
        stop: (name) => {
            // останавливаем под
        },
        status: (name) => {
            // возвращаем статус пода
        },
        remove: (name) => {
            // убираем под
        },

    });
};
```

После запуска такого пода будет создана новая "виртуальная" подошная поверх родительской. Она будет доступна по тому же порту, но при добавлении её в `pod remote` нужно будет указать путь `inner`. 

```
pod remote add new-origin http://localhost:3000 --path inner
```

Внутри виртуальной подошной можно продолжать создавать новые подошные, которые также будут хоститься в оригинальной (корневой). Путь в таком случае усложнится и будет `inner.second.wtf` и тд.

## Будущее

+ Сделать докер контейнер для подошной
+ Коллекции образов подов ???

+ Про общение друг с другом (плагварь)
+ Про общение подошной со скриптом лол

+ pod scale origin name 10 -- запускает 10 инстансов одного пода
+ Как работает скейлинг на сервере?
+ Как скейлить подошную?

+ Всё-таки надо в vm запускать, но давать какой-то доступ - так подошная сможет убить под если он подозрительный
+ Версионирование подов как будто норм тема, но вроде пока не нужно
+ При пуше может вернуться текст ответа -- классная фича на будущее
+ ещё в статус бы текст выводить удобно -- тоже классная фича но на будущее

+ КОНФИГ ПОДА? для react-router-app ??? подов - путь там и всё такое - типа флаги запуска -- нужно продумать во второй итерации

## Логирование

Подошная пишет свои логи в отдельный файл, который можно если что запросить. Подошная пишет логи с тэгами, поэтому можно запросить логи целиком или с определенными тэгами. Также подошная проставляет время, так что можно фильтровать по времени.

```
pod logs origin -- весь лог
pod logs origin name -- записи с тэгом именем пода
pod logs origin --time "last 5 mins" -- тут надо подумать лол
```
